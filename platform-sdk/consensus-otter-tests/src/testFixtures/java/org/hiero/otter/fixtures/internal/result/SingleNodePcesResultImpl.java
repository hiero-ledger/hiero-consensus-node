// SPDX-License-Identifier: Apache-2.0
package org.hiero.otter.fixtures.internal.result;

import static com.swirlds.platform.event.preconsensus.PcesFileManager.NO_LOWER_BOUND;
import static com.swirlds.platform.event.preconsensus.PcesUtilities.getDatabaseDirectory;
import static java.util.Objects.requireNonNull;

import com.hedera.hapi.platform.state.NodeId;
import com.swirlds.common.io.utility.NoOpRecycleBin;
import com.swirlds.config.api.Configuration;
import com.swirlds.platform.event.preconsensus.PcesFile;
import com.swirlds.platform.event.preconsensus.PcesFileReader;
import com.swirlds.platform.event.preconsensus.PcesFileTracker;
import com.swirlds.platform.event.preconsensus.PcesMultiFileIterator;
import edu.umd.cs.findbugs.annotations.NonNull;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.file.Path;
import java.util.Iterator;
import org.hiero.otter.fixtures.result.SingleNodePcesResult;

/**
 * An implementation of {@link SingleNodePcesResult} that provides access to a group of related PCES files that were
 * generated by a single node.
 */
public class SingleNodePcesResultImpl implements SingleNodePcesResult {

    private final NodeId nodeId;
    private final PcesFileTracker pcesFileTracker;

    /**
     * Constructor for {@code SingleNodePcesResultImpl} using the default PCES directory based on the node ID and
     * configuration.
     *
     * @param nodeId The {@link NodeId} of the files' node
     * @param configuration The {@link Configuration} to use for reading PCES files
     */
    public SingleNodePcesResultImpl(@NonNull final NodeId nodeId, @NonNull final Configuration configuration) {
        this(nodeId, configuration, defaultPcesDirectory(nodeId.id(), configuration));
    }

    /**
     * Constructor for {@code SingleNodePcesResultImpl} using a custom PCES directory.
     *
     * @param nodeId The {@link NodeId} of the files' node
     * @param configuration The {@link Configuration} to use for reading PCES files
     * @param pcesDirectory The directory where PCES files are stored
     */
    public SingleNodePcesResultImpl(
            @NonNull final NodeId nodeId,
            @NonNull final Configuration configuration,
            @NonNull final Path pcesDirectory) {
        this.nodeId = requireNonNull(nodeId);
        try {
            this.pcesFileTracker = PcesFileReader.readFilesFromDisk(
                    configuration, new NoOpRecycleBin(), pcesDirectory, NO_LOWER_BOUND, true);
        } catch (final IOException e) {
            throw new UncheckedIOException("Error initializing SingleNodePcesResultImpl", e);
        }
    }

    /**
     * Construct the default PCES directory based on the node ID and configuration.
     *
     * @param nodeId the ID of the node
     * @param configuration the configuration of the node
     * @return the default PCES directory path
     */
    private static Path defaultPcesDirectory(final long nodeId, final Configuration configuration) {
        try {
            return getDatabaseDirectory(configuration, org.hiero.consensus.model.node.NodeId.of(nodeId));
        } catch (final IOException e) {
            throw new UncheckedIOException("Error resolving default PCES directory", e);
        }
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public NodeId nodeId() {
        return nodeId;
    }

    /**
     * {@inheritDoc}
     */
    @Override
    @NonNull
    public Iterator<PcesFile> pcesFiles() {
        return pcesFileTracker.getFileIterator();
    }

    /**
     * {@inheritDoc}
     */
    @Override
    @NonNull
    public PcesMultiFileIterator pcesEvents() {
        return new PcesMultiFileIterator(NO_LOWER_BOUND, pcesFiles());
    }
}
