# SPDX-License-Identifier: Apache-2.0
name: "ZXC: Run HAPI Tests"
on:
  workflow_call:
    inputs:
      enable-hapi-tests-misc:
        description: "HAPI Testing (misc) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-misc-records:
        description: "HAPI Testng (misc records) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-crypto:
        description: "HAPI Testing (crypto) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-simplefees:
        description: "HAPI Testing (simplefees) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-token:
        description: "HAPI Testing (token) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-smart-contract:
        description: "HAPI Testing (smart contract) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-time-consuming:
        description: "HAPI Testing (time consuming) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-restart:
        description: "HAPI Testing (restart) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-iss:
        description: "HAPI Testing (ISS) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-bn-communication:
        description: "HAPI Testing (Block Node Communication) Enabled"
        type: boolean
        required: false
        default: false
      enable-hapi-tests-nd-reconnect:
        description: "HAPI Testing (node death reconnect) Enabled"
        type: boolean
        required: false
        default: false
      enable-network-log-capture:
        description: "Network Log Capture Enabled"
        type: boolean
        required: false
        default: false
      java-distribution:
        description: "Java JDK Distribution:"
        type: string
        required: false
        default: "temurin"
      java-version:
        description: "Java JDK Version:"
        type: string
        required: false
        default: "21.0.6"
      node-version:
        description: "NodeJS Version:"
        type: string
        required: false
        default: "20"
      custom-job-label:
        description: "Custom Job Label:"
        type: string
        required: false
        default: "Compiles"
      ref:
        description: "The branch, tag or SHA to checkout."
        required: false
        type: string
      mats-suffix:
        description: "MATS Tag Suffix designation"
        type: string
        required: false
        default: ""

    secrets:
      access-token:
        description: "The Github access token used to checkout the repository, submodules, and make GitHub API calls."
        required: true
      gradle-cache-username:
        description: "The username used to authenticate with the Gradle Build Cache Node."
        required: true
      gradle-cache-password:
        description: "The password used to authenticate with the Gradle Build Cache Node."
        required: true
      codacy-project-token:
        description: "The Codacy project token used to report code coverage."
        required: false
      codecov-token:
        description: "The Codecov token used to report code coverage."
        required: false

    outputs:
      failure-mode:
        description: "Indicates the failure mode of the job, if any."
        value: ${{ jobs.calculate-failure-mode.outputs.failure-mode }}

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  actions: read
  pull-requests: write
  statuses: write
  checks: write
  contents: read

env:
  GRADLE_CACHE_USERNAME: ${{ secrets.gradle-cache-username }}
  GRADLE_CACHE_PASSWORD: ${{ secrets.gradle-cache-password }}
  GRADLE_EXEC: ionice -c 2 -n 2 nice -n 19 ./gradlew
  CG_EXEC: ionice -c 2 -n 2 nice -n 19

jobs:
  hapi-tests-misc:
    name: ${{ inputs.custom-job-label || 'HAPI Tests (Misc)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-misc }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Misc)
        id: gradle-hapi-misc
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        # Run each tasks in isolation because we dynamically reconfigure Log4j for each mode
        run: ${GRADLE_EXEC} hapiTestMisc${{ inputs.mats-suffix }} --no-daemon && ${GRADLE_EXEC} hapiEmbeddedMisc${{ inputs.mats-suffix }} --no-daemon && ${GRADLE_EXEC} hapiRepeatableMisc${{ inputs.mats-suffix }} --no-daemon

      - name: Publish HAPI Test (Misc) Report
        id: publish-hapi-misc-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Misc) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/**/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Misc) Report Artifacts
        id: publish-hapi-misc-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Misc) Reports
          path: "**/test-clients/build/test-results/**/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Misc) Network Logs
        id: hapi-test-misc-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-misc && inputs.enable-network-log-capture && steps.gradle-hapi-misc.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Misc) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-misc.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-misc-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-misc-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-misc-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-misc-records:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Misc Records)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-misc-records && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Misc Records)
        id: gradle-hapi-misc-records
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestMiscRecords${{ inputs.mats-suffix }}

      - name: Publish HAPI Test (Misc Records) Report
        id: publish-hapi-misc-records-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Misc Records) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Misc Records) Report Artifacts
        id: publish-hapi-misc-records-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Misc Records) Report
          path: "**/test-clients/build/test-results/**/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Misc Records) Network Logs
        id: hapi-test-misc-records-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-misc-records && inputs.enable-network-log-capture && steps.gradle-hapi-misc-records.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Misc Records) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-misc-records.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-misc-records-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-misc-records-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-misc-records-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-crypto:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Crypto)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-crypto && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Crypto)
        id: gradle-hapi-crypto
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestCrypto${{ inputs.mats-suffix || '' }}

      - name: Publish HAPI Test (Crypto) Report
        id: publish-hapi-crypto-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Crypto) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Crypto) Report Artifacts
        id: publish-hapi-crypto-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Crypto) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (crypto) Network Logs
        id: hapi-test-crypto-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-crypto && inputs.enable-network-log-capture && steps.gradle-hapi-crypto.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Crypto) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-crypto.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-crypto-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-crypto-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-crypto-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-simplefees:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Simple Fees)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-simplefees && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Simple Fees)
        id: gradle-hapi-simplefees
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestSimpleFees${{ inputs.mats-suffix || '' }}

      - name: Publish HAPI Test (Simple Fees) Report
        id: publish-hapi-simplefees-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Simple Fees) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Simple Fees) Report Artifacts
        id: publish-hapi-simplefees-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Simple Fees) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Simple Fees) Network Logs
        id: hapi-test-simplefees-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-simplefees && inputs.enable-network-log-capture && steps.gradle-hapi-simplefees.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Simple Fees) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-simplefees.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-simplefees-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-simplefees-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-simplefees-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-token:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Token)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-token && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Token)
        id: gradle-hapi-token
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestToken${{ inputs.mats-suffix || '' }} --no-daemon

      - name: Publish HAPI Test (Token) Report
        id: publish-hapi-token-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Token) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Token) Report Artifacts
        id: publish-hapi-token-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Token) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Token) Network Logs
        id: hapi-test-token-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-token && inputs.enable-network-log-capture && steps.gradle-hapi-token.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Token) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-token.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-token-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-token-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-token-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-smart-contract:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Smart Contract)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-smart-contract && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Smart Contract)
        id: gradle-hapi-smart-contract
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestSmartContract${{ inputs.mats-suffix || '' }}

      - name: Publish HAPI Test (Smart Contract) Report
        id: publish-hapi-smart-contract-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Smart Contract) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Smart Contract) Report Artifacts
        id: publish-hapi-smart-contract-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Smart Contract) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Smart Contract) Network Logs
        id: hapi-test-smart-contract-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-smart-contract && inputs.enable-network-log-capture && steps.gradle-hapi-smart-contract.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Smart Contract) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-smart-contract.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-smart-contract-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-smart-contract-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-smart-contract-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-time-consuming:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Time Consuming)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-time-consuming && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Time Consuming)
        id: gradle-hapi-time-consuming
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestTimeConsuming

      - name: Publish HAPI Test (Time Consuming) Report
        id: publish-hapi-time-consuming-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Time Consuming) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Time Consuming) Report Artifacts
        id: publish-hapi-time-consuming-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Time Consuming) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Time Consuming) Network Logs
        id: hapi-test-time-consuming-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-time-consuming && inputs.enable-network-log-capture && steps.gradle-hapi-time-consuming.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Time Consuming) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-time-consuming.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-time-consuming-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-time-consuming-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-time-consuming-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-restart:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Restart)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-restart && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Restart)
        id: gradle-hapi-restart
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestRestart

      - name: Publish HAPI Test (Restart) Report
        id: publish-hapi-restart-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Restart) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Restart) Report Artifacts
        id: publish-hapi-restart-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Restart) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Restart) Network Logs
        id: hapi-test-restart-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-restart && inputs.enable-network-log-capture && steps.gradle-hapi-restart.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Restart) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-restart.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-restart-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-restart-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-restart-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-nd-reconnect:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Node Death Reconnect)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-nd-reconnect && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Node Death Reconnect)
        id: gradle-hapi-nd-reconnect
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestNDReconnect

      - name: Publish HAPI Test (Node Death Reconnect) Report
        id: publish-hapi-nd-reconnect-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Node Death Reconnect) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Node Death Reconnect) Report Artifacts
        id: publish-hapi-nd-reconnect-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Node Death Reconnect) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Node Death Reconnect) Network Logs
        id: hapi-test-nd-reconnect-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-nd-reconnect && inputs.enable-network-log-capture && steps.gradle-hapi-nd-reconnect.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Node Death Reconnect) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-nd-reconnect.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-nd-reconnect-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-nd-reconnect-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-nd-reconnect-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-iss:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (ISS)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-iss && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (ISS)
        id: gradle-hapi-iss
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestIss

      - name: Publish HAPI Test (ISS) Report
        id: publish-hapi-iss-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (ISS) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (ISS) Report Artifacts
        id: publish-hapi-iss-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (ISS) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (ISS) Network Logs
        id: hapi-test-iss-network-logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ inputs.enable-hapi-tests-iss && inputs.enable-network-log-capture && steps.gradle-hapi-iss.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (ISS) Network Logs
          path: |
            hedera-node/test-clients/build/hapi-test/**/output/**
            hedera-node/test-clients/build/hapi-test/*.log
            hedera-node/test-clients/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-iss.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-iss-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-iss-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.hapi-test-iss-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  hapi-tests-bn-communication:
    name: ${{ inputs.custom-job-label || 'Hapi Tests (Block Node Communications)' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ inputs.enable-hapi-tests-bn-communication && !cancelled() }}
    outputs:
      failure-mode: ${{ steps.set-failure-mode.outputs.mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: HAPI Testing (Block Node Communication)
        id: gradle-hapi-bn-communication
        env:
          LC_ALL: en.UTF-8
          LANG: en_US.UTF-8
        run: ${GRADLE_EXEC} hapiTestBlockNodeCommunication

      - name: Publish HAPI Test (Block Node Communication) Report
        id: publish-hapi-bn-report
        uses: step-security/publish-unit-test-result-action@5d195d4dec0b9fa7b51a3dbc4298362a021247c7 # v2.20.4
        with:
          check_name: "Node: HAPI Test (Block Node Communication) Results"
          json_thousands_separator: ","
          junit_files: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          comment_mode: errors # only comment if we could not find or parse the JUnit XML files

      - name: Upload HAPI Test (Block Node Communication) Report Artifacts
        id: publish-hapi-bn-artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: HAPI Test (Block Node Communication) Report
          path: "**/test-clients/build/test-results/testSubprocess/TEST-*.xml"
          retention-days: 7

      - name: Upload HAPI Test (Block Node Communication) Network Logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        id: publish-hapi-bn-network-logs
        if: ${{ inputs.enable-hapi-tests-bn-communication && inputs.enable-network-log-capture && steps.gradle-hapi-bn-communication.conclusion == 'failure' && !cancelled() }}
        with:
          name: HAPI Test (Block Node Communication) Network Logs
          path: |
            hedera-node/test-clients/build/*-test/**/output/**
          retention-days: 7

      - name: Set Failure Mode
        id: set-failure-mode
        if: ${{ !cancelled() && always() }}
        run: |
          mode="none"
          if [[ "${{ steps.initialize.conclusion }}" == "failure" ]]; then
            mode="workflow"
          fi
          if [[ "${{ steps.gradle-hapi-bn-communication.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-bn-report.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-bn-artifacts.conclusion }}" == "failure" ]] || \
            [[ "${{ steps.publish-hapi-bn-network-logs.conclusion }}" == "failure" ]]; then
            if [[ "${mode}" == "none" ]]; then
              mode="general"
            fi
          fi

          echo "mode=${mode}" >> "${GITHUB_OUTPUT}"

  calculate-failure-mode:
    name: ${{ inputs.custom-job-label || 'Calculate Failure Mode' }}
    runs-on: hiero-network-node-linux-large
    if: ${{ always() }}
    needs:
      - hapi-tests-misc
      - hapi-tests-misc-records
      - hapi-tests-crypto
      - hapi-tests-simplefees
      - hapi-tests-token
      - hapi-tests-smart-contract
      - hapi-tests-time-consuming
      - hapi-tests-restart
      - hapi-tests-nd-reconnect
      - hapi-tests-iss
      - hapi-tests-bn-communication
    outputs:
      failure-mode: ${{ steps.calculate-failure-mode.outputs.failure-mode }}
    steps:
      - name: Initialize Job
        id: initialize
        uses: pandaswhocode/initialize-github-job@89e4edd83df490f0cc6f3dca22bebf076cea94a6 # v1.0.0
        with:
          checkout: true
          checkout-token: ${{ secrets.access-token }}
          checkout-fetch-depth: "0"
          checkout-ref: ${{ inputs.ref }}
          setup-java: true
          java-version: ${{ inputs.java-version }}
          java-distribution: ${{ inputs.java-distribution }}
          setup-node: true
          node-version: ${{ inputs.node-version }}
          setup-gradle: true
          gradle-cache-read-only: false

      - name: Check Results
        id: calculate-failure-mode
        run: |
          ci_cd_modes=(
            "${{ needs.compile.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-misc.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-misc-records.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-crypto.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-simplefees.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-token.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-smart-contract.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-time-consuming.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-restart.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-nd-reconnect.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-iss.outputs.failure-mode || 'none' }}"
            "${{ needs.hapi-tests-bn-communication.outputs.failure-mode || 'none' }}"
            "${{ needs.snyk-checks.outputs.failure-mode || 'none' }}"
          )

          # Check if failure mode is set.
          # Return the first encountered failure mode.
          failure_mode="none"
          for mode in ${ci_cd_modes[@]}; do
            if [[ "${mode}" != "workflow" ]]; then
              failure_mode="${mode}"
              break
            fi
          done

          echo "failure-mode=${failure_mode}" >> "${GITHUB_OUTPUT}"
