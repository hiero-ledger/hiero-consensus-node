# SPDX-License-Identifier: Apache-2.0
name: "Node: PR Checks"
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - labeled

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  actions: read
  pull-requests: write
  statuses: write
  checks: write
  contents: read

concurrency:
  group: pr-checks-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  detect-change-type:
    name: Detect Change Type
    runs-on: hl-cn-default-lin-sm
    outputs:
      docs-only: ${{ steps.classify.outputs.docs-only }}
      enable-tests: ${{ steps.classify.outputs.enable-tests }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Classify Changed Files
        id: classify
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6
        with:
          script: |
            // Check for run-full-ci label first — forces full CI regardless
            const labels = context.payload.pull_request.labels || [];
            if (labels.some(l => l.name === 'run-full-ci')) {
              core.info('Label "run-full-ci" detected — forcing full CI');
              core.setOutput('docs-only', 'false');
              core.setOutput('enable-tests', 'true');
              return;
            }

            // Fetch changed files (first page only, max 100)
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100
            });

            // Conservative: if no files or >=100 files, run full CI
            if (files.length === 0 || files.length >= 100) {
              core.info(`File count (${files.length}) triggers full CI (conservative)`);
              core.setOutput('docs-only', 'false');
              core.setOutput('enable-tests', 'true');
              return;
            }

            // Conservative allowlist: only these patterns are considered documentation
            const docPatterns = [
              /\.md$/i,                // Markdown files
              /^LICENSE(\..*)?$/i,     // LICENSE, LICENSE.txt, etc.
              /^NOTICE(\..*)?$/i,      // NOTICE, NOTICE.txt, etc.
              /(^|\/)docs\//,          // Files in docs/ directories
              /(^|\/)doc\//,           // Files in doc/ directories
            ];

            const isDocFile = (filename) =>
              docPatterns.some(pattern => pattern.test(filename));

            const nonDocFiles = files.filter(f => !isDocFile(f.filename));

            if (nonDocFiles.length > 0) {
              core.info(`Found ${nonDocFiles.length} non-doc file(s) — full CI required`);
              nonDocFiles.slice(0, 10).forEach(f => core.info(`  - ${f.filename}`));
              core.setOutput('docs-only', 'false');
              core.setOutput('enable-tests', 'true');
            } else {
              core.info(`All ${files.length} changed file(s) are documentation — docs-only mode`);
              core.setOutput('docs-only', 'true');
              core.setOutput('enable-tests', 'false');
            }

  mats-pr-checks:
    name: MATS
    needs:
      - detect-change-type
    uses: ./.github/workflows/zxc-mats-tests.yaml
    with:
      ref: ${{ github.event.pull_request.head.sha }}
      enable-dependency-check: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-spotless-check: "true"
      enable-snyk-scan: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-unit-tests: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-integration-tests: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-hapi-tests: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-hapi-tests-crypto: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-otter-tests: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-gradle-determinism: ${{ needs.detect-change-type.outputs.enable-tests }}
      enable-docker-determinism: ${{ needs.detect-change-type.outputs.enable-tests }}
      java-version: "21.0.6"
      java-distribution: "temurin"
      custom-job-label: "Standard"
    secrets:
      access-token: ${{ secrets.GITHUB_TOKEN }}
      codacy-project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      codecov-token: ${{ secrets.CODECOV_TOKEN }}
      gradle-cache-username: ${{ secrets.GRADLE_CACHE_USERNAME }}
      gradle-cache-password: ${{ secrets.GRADLE_CACHE_PASSWORD }}
      snyk-token: ${{ secrets.SNYK_TOKEN }}

  ci-complete:
    name: CI Complete
    runs-on: hl-cn-default-lin-sm
    needs:
      - detect-change-type
      - mats-pr-checks
    if: ${{ !cancelled() && always() }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Evaluate Results
        run: |
          echo "Docs-only: ${{ needs.detect-change-type.outputs.docs-only }}"
          echo "MATS result: ${{ needs.mats-pr-checks.result }}"

          if [[ "${{ needs.mats-pr-checks.result }}" == "success" ]]; then
            echo "All required checks passed."
            exit 0
          else
            echo "MATS checks did not succeed (result: ${{ needs.mats-pr-checks.result }})."
            exit 1
          fi

  report-summary:
    name: Report PR Check Summary
    runs-on: hl-cn-default-lin-sm
    needs:
      - detect-change-type
      - mats-pr-checks
    if: ${{ !cancelled() && always() }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: "0"
          ref: ${{ inputs.ref || '' }}

      - name: Report Summary
        id: report-summary
        env:
          PRINT_FAILED_TESTS_SCRIPT: ".github/workflows/support/scripts/print-failed-tests.sh"
        run: |
          echo "::debug::Generating PR Check Summary"

          # Append summary to GitHub Step Summary
          {
            echo "## PR Check Summary"
            echo ""
            if [[ "${{ needs.detect-change-type.outputs.docs-only }}" == "true" ]]; then
              echo "> **Docs-only PR detected.** Unit, integration, HAPI, otter, determinism, dependency, and Snyk checks were skipped. Build and Spotless still ran."
              echo ""
            fi
            echo "------------------------------------"
            echo "### Results"
            echo "- **MATS Tests:** ${{ needs.mats-pr-checks.result }}"
            echo "------------------------------------"
            if [[ "${{ needs.mats-pr-checks.result }}" == "failure" ]]; then
                echo "### MATS Test Failures"
                echo ""
                echo "- **Failure Mode:** ${{ needs.mats-pr-checks.outputs.failure-mode }}"
                echo "- **Failed Tests:**"
                bash "${{ github.workspace }}/${{ env.PRINT_FAILED_TESTS_SCRIPT }}" "${{ needs.mats-pr-checks.outputs.failed-tests }}"
                echo "------------------------------------"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
