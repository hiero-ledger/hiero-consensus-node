# SPDX-License-Identifier: Apache-2.0
name: "Node: PR Checks"
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  actions: read
  pull-requests: write
  statuses: write
  checks: write
  contents: read

concurrency:
  group: pr-checks-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  mats-pr-checks:
    name: MATS
    uses: ./.github/workflows/zxc-mats-tests.yaml
    with:
      ref: ${{ github.event.pull_request.head.sha }}
      enable-dependency-check: "true"
      enable-spotless-check: "true"
      enable-snyk-scan: "true"
      enable-unit-tests: "true"
      enable-integration-tests: "true"
      enable-hapi-tests: "true"
      enable-hapi-tests-crypto: "true"
      enable-otter-tests: "true"
      enable-gradle-determinism: "true"
      enable-docker-determinism: "true"
      java-version: "21.0.6"
      java-distribution: "temurin"
      custom-job-label: "Standard"
    secrets:
      access-token: ${{ secrets.GITHUB_TOKEN }}
      codacy-project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      codecov-token: ${{ secrets.CODECOV_TOKEN }}
      gradle-cache-username: ${{ secrets.GRADLE_CACHE_USERNAME }}
      gradle-cache-password: ${{ secrets.GRADLE_CACHE_PASSWORD }}
      snyk-token: ${{ secrets.SNYK_TOKEN }}

  report-summary:
    name: Report PR Check Summary
    runs-on: hl-cn-default-lin-sm
    needs:
      - mats-pr-checks
    if: ${{ !cancelled() && always() }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: "0"
          ref: ${{ inputs.ref || '' }}

      - name: Report Summary
        id: report-summary
        env:
          PRINT_FAILED_TESTS_SCRIPT: ".github/workflows/support/scripts/print-failed-tests.sh"
        run: |
          echo "::debug::Generating PR Check Summary"

          # Append summary to GitHub Step Summary
          {
            echo "## PR Check Summary"
            echo ""
            echo "------------------------------------"
            echo "### Results"
            echo "- **MATS Tests:** ${{ needs.mats-pr-checks.result }}"
            echo "------------------------------------"
            if [[ "${{ needs.mats-pr-checks.result }}" == "failure" ]]; then
                echo "### MATS Test Failures"
                echo ""
                echo "- **Failure Mode:** ${{ needs.mats-pr-checks.outputs.failure-mode }}"
                echo "- **Failed Tests:**"
                bash "${{ github.workspace }}/${{ env.PRINT_FAILED_TESTS_SCRIPT }}" "${{ needs.mats-pr-checks.outputs.failed-tests }}"
                echo "------------------------------------"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Download Test Report Artifacts
        id: download-test-reports
        if: ${{ !cancelled() && always() }}
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        continue-on-error: true
        with:
          pattern: "*Test*Report*"
          path: test-reports/

      - name: Collect Flaky Tests
        id: collect-flaky-tests
        if: ${{ !cancelled() && always() && steps.download-test-reports.outcome == 'success' }}
        run: |
          bash "${{ github.workspace }}/.github/workflows/support/scripts/collect-flaky-tests.sh" \
            "test-reports" \
            "flaky-tests.txt"
          FLAKY_COUNT=$(wc -l < flaky-tests.txt | tr -d ' ')
          echo "flaky-count=${FLAKY_COUNT}" >> "${GITHUB_OUTPUT}"
          if [[ "${FLAKY_COUNT}" -gt 0 ]]; then
            {
              echo "flaky-tests<<EOF"
              cat flaky-tests.txt
              echo "EOF"
            } >> "${GITHUB_OUTPUT}"
          fi

      - name: Comment Flaky Tests on PR
        if: ${{ !cancelled() && always() && steps.collect-flaky-tests.outputs.flaky-count > 0 }}
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const flakyTests = `${{ steps.collect-flaky-tests.outputs.flaky-tests }}`.trim().split('\n').filter(Boolean);
            const marker = '<!-- flaky-test-report -->';

            let body = marker + '\n';
            body += '## Flaky Tests Detected\n\n';
            body += 'The following tests were flaky in this CI run (failed initially but passed on retry):\n\n';
            body += '| Test |\n';
            body += '|------|\n';
            for (const test of flakyTests) {
              body += `| \`${test}\` |\n`;
            }
            body += '\n> **Note:** Flaky tests are informational only and do not block this PR.\n';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body,
              });
            }
