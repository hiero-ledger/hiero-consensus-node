# OpenTelemetry Converter for Hedera Services
This module is a command line converter that processes Java Flight Recorder (JFR) files and Block Stream data generated 
by Hedera Services nodes and exports the extracted telemetry data to OpenTelemetry-compatible backends such as Grafana 
Tempo (for traces) and Prometheus (for metrics).

The converter takes two directories configuration as input:
- `tracing.converter.jfrDirectory` - directory containing JFR files generated by Flight Recorder on each node
- `tracing.converter.blockStreamsDirectory` - directory containing Block Streams data generated by single node

### Collecting Flight Recorder Data
To collect JFR data, you need to enable Java Flight Recorder on each Hedera Services node in one of these 3 methods:
 - By adding the following JVM option when running node to record all data while the node is running. (it must be 
   shutdown cleanly and not force killed for data to be saved)  
   ```-XX:StartFlightRecording=filename=recording-node-1.jfr,disk=true,dumponexit=true```
 - By starting and stopping recording on demand using JCMD tool. For example, to start recording on node with PID 12345:  
   ```jcmd 12345 JFR.start name=MyRecording filename=recording-node-1.jfr duration=300s dumponexit=true```  
   Where 12345 is the process ID for the node process from `jps` command. To stop the recording before the duration expires:
   ```jcmd 12345 JFR.stop name=MyRecording``` The duration can be omitted if you want to run recording until stopped.  
### How to process results and view in Grafana
1. Collect all the JFR files from each node into a single directory, e.g. `./build/jfr-data`
2. Collect Block Streams data from a single node into a directory, e.g. `./build/blockstreams-data`
3. Start Docker containers for Tempo, Prometheus and Grafana  
   `./gradlew :open-telemetry:startDockerContainers`
5. Run Open Telemetry converter to process results and export to Tempo and Prometheus   
   `./gradlew -Dtracing.converter.jfrDirectory=./build/jfr-data -Dtracing.converter.blockStreamsDirectory=./build/blockstreams-data :open-telemetry:run`

### How ro run HAPI tests with OpenTelemetry 

1. Clean HAPI test output directory, if you want fresh test without previously recorded telemetry (optional)  
    `./gradlew :test-clients:cleanData`
2. Clean debug output, Tempo and Prometheus Docker data, if you need clean databases (optional)  
    `./gradlew :open-telemetry:cleanData`
3. Run HAPI test generating some load (duration and TPS can be modified in the test code)  
   `./gradlew :test-clients:testSubprocess --tests "com.hedera.services.bdd.suites.regression.UmbrellaRedux.umbrellaRedux"`
4. Start Docker containers, if not yet running  
   `./gradlew :open-telemetry:startDockerContainers`
5. Run Open Telemetry converter to process HAPI test results and export to Tempo and Prometheus   
   `./gradlew :open-telemetry:runOnHapiTestOutput`
6. Open Grafana dashboard at http://localhost:3000/explore and explore Spans and Metrics  
7. Stop Docker containers, if needed  
   `./gradlew :open-telemetry:stopDockerContainers`  


### Telemetry Converter Development Loop
  `./gradlew :open-telemetry:re-runOnHapiTestOutput`